<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Library - MyLibrary</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <header>
    <div class="container">
      <h1><a href="/">MyLibrary</a></h1>
      <nav>
        <a href="/library" class="active">My Library</a>
        <a href="/pinned">Pinned Books</a>
        <a href="/explore">Explore</a>
        <a href="/my-requests">My Requests</a>
        <a href="/access-requests">Access Requests</a>
        <a href="/upload">Upload</a>
        <a href="/account">Account</a>
        <a href="/logout">Logout</a>
      </nav>
    </div>
  </header>
  
  <main class="container">
    <h2>My Library</h2>
    
    <div class="search-container">
      <form>
        <input type="text" id="searchInput" placeholder="Search your library..." required>
        <button type="button" id="searchButton" class="btn btn-primary">Search</button>
      </form>
    </div>
    
    <div class="book-grid" id="bookGrid">
      <% if (books.length === 0) { %>
        <div class="empty-state">
          <p>Your library is empty. <a href="/upload">Upload your first book</a> to get started.</p>
        </div>
      <% } else { %>
        <% books.forEach(book => { %>
          <div class="book-card" data-id="<%= book._id %>">
            <div class="book-cover">
              <img src="/thumbnail/<%= book._id %>" alt="<%= book.title %> cover" class="thumbnail" onerror="this.src='/images/default-thumbnail.png'">
              <div class="pin-icon <%= pinnedBooks.includes(book._id.toString()) ? 'pinned' : '' %>" data-book-id="<%= book._id %>">
                <span class="pin-count"><%= book.pinCount || 0 %></span>
                ðŸ“Œ
              </div>
            </div>
            <div class="book-info">
              <h3><%= book.title %></h3>
              <p class="author"><%= book.author %></p>
              <span class="visibility-badge visibility-<%= book.visibility %>">
                <%= book.visibility.charAt(0).toUpperCase() + book.visibility.slice(1) %>
              </span>
              <div class="book-actions">
                <a href="/view/<%= book._id %>" class="btn btn-primary">Read</a>
                <button class="btn btn-secondary manage-sharing" data-book-id="<%= book._id %>" data-visibility="<%= book.visibility %>">Share</button>
                <button class="btn btn-danger delete-book">Delete</button>
              </div>
            </div>
          </div>
        <% }) %>
      <% } %>
    </div>
  </main>
  
  <div id="sharingModal" class="modal">
    <div class="modal-content">
      <span class="close">Ã—</span>
      <h3>Manage Sharing</h3>
      <p id="bookTitle"></p>
      <div class="visibility-controls">
        <label for="visibilitySelect">Visibility:</label>
        <select id="visibilitySelect">
          <option value="private">Private</option>
          <option value="public">Public</option>
          <option value="restricted">Restricted</option>
        </select>
      </div>
      <div id="accessListSection" style="display: none;">
        <h4>Users with Access</h4>
        <div class="access-list" id="accessList"></div>
      </div>
      <button id="saveVisibility" class="btn btn-primary">Save</button>
    </div>
  </div>
  
  <footer>
    <div class="container">
      <p>Â© 2025 MyLibrary. All rights reserved.</p>
    </div>
  </footer>
  
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const deleteButtons = document.querySelectorAll('.delete-book');
      deleteButtons.forEach(button => {
        button.addEventListener('click', async (e) => {
          const bookCard = e.target.closest('.book-card');
          const bookId = bookCard.dataset.id;
          if (confirm('Are you sure you want to delete this book?')) {
            try {
              const response = await fetch(`/book/${bookId}`, { method: 'DELETE' });
              const data = await response.json();
              if (data.success) {
                bookCard.remove();
                if (document.querySelectorAll('.book-card').length === 0) {
                  document.querySelector('.book-grid').innerHTML = `
                    <div class="empty-state">
                      <p>Your library is empty. <a href="/upload">Upload your first book</a> to get started.</p>
                    </div>
                  `;
                }
              } else {
                alert(data.message || 'Failed to delete book');
              }
            } catch (err) {
              alert('Error deleting book');
            }
          }
        });
      });

      const sharingButtons = document.querySelectorAll('.manage-sharing');
      const modal = document.getElementById('sharingModal');
      const closeBtn = document.querySelector('.close');
      const visibilitySelect = document.getElementById('visibilitySelect');
      const accessListSection = document.getElementById('accessListSection');
      const accessList = document.getElementById('accessList');
      const saveBtn = document.getElementById('saveVisibility');
      let currentBookId = null;

      sharingButtons.forEach(button => {
        button.addEventListener('click', async (e) => {
          const bookCard = e.target.closest('.book-card');
          const bookId = button.dataset.bookId;
          const bookTitle = bookCard.querySelector('h3').textContent;
          const currentVisibility = button.dataset.visibility;
          
          currentBookId = bookId;
          document.getElementById('bookTitle').textContent = bookTitle;
          visibilitySelect.value = currentVisibility;
          toggleAccessListSection(currentVisibility);
          if (currentVisibility === 'restricted') {
            await fetchAccessList(bookId);
          }
          modal.style.display = 'block';
        });
      });

      closeBtn.addEventListener('click', () => {
        modal.style.display = 'none';
      });

      window.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.style.display = 'none';
        }
      });

      visibilitySelect.addEventListener('change', () => {
        toggleAccessListSection(visibilitySelect.value);
      });

      saveBtn.addEventListener('click', async () => {
        const newVisibility = visibilitySelect.value;
        try {
          const response = await fetch(`/book/${currentBookId}/visibility`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ visibility: newVisibility })
          });
          const data = await response.json();
          if (data.success) {
            const bookCard = document.querySelector(`.book-card[data-id="${currentBookId}"]`);
            const visibilityBadge = bookCard.querySelector('.visibility-badge');
            const manageSharingBtn = bookCard.querySelector('.manage-sharing');
            visibilityBadge.className = `visibility-badge visibility-${newVisibility}`;
            visibilityBadge.textContent = newVisibility.charAt(0).toUpperCase() + newVisibility.slice(1);
            manageSharingBtn.dataset.visibility = newVisibility;
            modal.style.display = 'none';
            alert('Visibility updated');
          } else {
            alert(data.message || 'Failed to update visibility');
          }
        } catch (err) {
          alert('Error updating visibility');
        }
      });

      function toggleAccessListSection(visibility) {
        accessListSection.style.display = visibility === 'restricted' ? 'block' : 'none';
      }

      async function fetchAccessList(bookId) {
        try {
          const response = await fetch(`/book/${bookId}/access-list`);
          const data = await response.json();
          if (data.success) {
            accessList.innerHTML = data.users.length === 0 ? '<p>No users have access.</p>' : '';
            data.users.forEach(user => {
              const listItem = document.createElement('div');
              listItem.className = 'access-list-item';
              listItem.innerHTML = `
                <span>${user.username} (${user.email})</span>
                <button class="btn btn-small btn-danger remove-access" data-user-id="${user._id}">Remove</button>
              `;
              accessList.appendChild(listItem);
            });
            document.querySelectorAll('.remove-access').forEach(button => {
              button.addEventListener('click', async (e) => {
                const userId = e.target.dataset.userId;
                try {
                  const response = await fetch(`/book/${currentBookId}/access/${userId}`, { method: 'DELETE' });
                  const data = await response.json();
                  if (data.success) {
                    e.target.closest('.access-list-item').remove();
                    if (accessList.children.length === 0) {
                      accessList.innerHTML = '<p>No users have access.</p>';
                    }
                  } else {
                    alert(data.message || 'Failed to remove access');
                  }
                } catch (err) {
                  alert('Error removing access');
                }
              });
            });
          } else {
            accessList.innerHTML = '<p>Failed to load access list.</p>';
          }
        } catch (err) {
          accessList.innerHTML = '<p>Failed to load access list.</p>';
        }
      }

      const pinButtons = document.querySelectorAll('.pin-icon');
      pinButtons.forEach(button => {
        button.addEventListener('click', async (e) => {
          e.preventDefault();
          const bookId = button.dataset.bookId;
          try {
            const response = await fetch(`/book/${bookId}/pin`, { method: 'POST' });
            const data = await response.json();
            if (data.success) {
              button.classList.toggle('pinned');
              const pinCountSpan = button.querySelector('.pin-count');
              pinCountSpan.textContent = data.pinCount;
            } else {
              alert('Failed to update pin status');
            }
          } catch (err) {
            alert('Error updating pin');
          }
        });
      });

      const searchInput = document.getElementById('searchInput');
      const searchButton = document.getElementById('searchButton');
      const bookGrid = document.getElementById('bookGrid');
      
      searchButton.addEventListener('click', performSearch);
      searchInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          performSearch();
        }
      });
      
      async function performSearch() {
        const query = searchInput.value.trim();
        if (!query) return;
        try {
          const response = await fetch(`/library/search?query=${encodeURIComponent(query)}`);
          const data = await response.json();
          if (data.books) {
            bookGrid.innerHTML = '';
            if (data.books.length === 0) {
              bookGrid.innerHTML = `
                <div class="empty-state">
                  <p>No books found for "${query}". <a href="/upload">Upload a book</a>.</p>
                </div>
              `;
            } else {
              data.books.forEach(book => {
                const isPinned = '<%= user.pinnedBooks %>'.includes(book._id);
                const bookCard = document.createElement('div');
                bookCard.className = 'book-card';
                bookCard.dataset.id = book._id;
                bookCard.innerHTML = `
                  <div class="book-cover">
                    <img src="/thumbnail/${book._id}" alt="${book.title} cover" class="thumbnail" onerror="this.src='/images/default-thumbnail.png'">
                    <div class="pin-icon ${isPinned ? 'pinned' : ''}" data-book-id="${book._id}">
                      <span class="pin-count">${book.pinCount || 0}</span>
                      ðŸ“Œ
                    </div>
                  </div>
                  <div class="book-info">
                    <h3>${book.title}</h3>
                    <p class="author">${book.author}</p>
                    <span class="visibility-badge visibility-${book.visibility}">
                      ${book.visibility.charAt(0).toUpperCase() + book.visibility.slice(1)}
                    </span>
                    <div class="book-actions">
                      <a href="/view/${book._id}" class="btn btn-primary">Read</a>
                      <button class="btn btn-secondary manage-sharing" data-book-id="${book._id}" data-visibility="${book.visibility}">Share</button>
                      <button class="btn btn-danger delete-book">Delete</button>
                    </div>
                  </div>
                `;
                bookGrid.appendChild(bookCard);
              });
              attachEventListeners();
            }
          }
        } catch (err) {
          alert('Search error');
        }
      }

      function attachEventListeners() {
        document.querySelectorAll('.delete-book').forEach(button => {
          button.addEventListener('click', async (e) => {
            const bookCard = e.target.closest('.book-card');
            const bookId = bookCard.dataset.id;
            if (confirm('Are you sure you want to delete this book?')) {
              try {
                const response = await fetch(`/book/${bookId}`, { method: 'DELETE' });
                const data = await response.json();
                if (data.success) {
                  bookCard.remove();
                  if (document.querySelectorAll('.book-card').length === 0) {
                    document.querySelector('.book-grid').innerHTML = `
                      <div class="empty-state">
                        <p>Your library is empty. <a href="/upload">Upload your first book</a> to get started.</p>
                      </div>
                    `;
                  }
                } else {
                  alert(data.message || 'Failed to delete book');
                }
              } catch (err) {
                alert('Error deleting book');
              }
            }
          });
        });

        document.querySelectorAll('.pin-icon').forEach(button => {
          button.addEventListener('click', async (e) => {
            e.preventDefault();
            const bookId = button.dataset.bookId;
            try {
              const response = await fetch(`/book/${bookId}/pin`, { method: 'POST' });
              const data = await response.json();
              if (data.success) {
                button.classList.toggle('pinned');
                const pinCountSpan = button.querySelector('.pin-count');
                pinCountSpan.textContent = data.pinCount;
              } else {
                alert('Failed to update pin status');
              }
            } catch (err) {
              alert('Error updating pin');
            }
          });
        });

        document.querySelectorAll('.manage-sharing').forEach(button => {
          button.addEventListener('click', async (e) => {
            const bookCard = e.target.closest('.book-card');
            const bookId = button.dataset.bookId;
            const bookTitle = bookCard.querySelector('h3').textContent;
            const currentVisibility = button.dataset.visibility;
            currentBookId = bookId;
            document.getElementById('bookTitle').textContent = bookTitle;
            visibilitySelect.value = currentVisibility;
            toggleAccessListSection(currentVisibility);
            if (currentVisibility === 'restricted') {
              await fetchAccessList(bookId);
            }
            modal.style.display = 'block';
          });
        });
      }
    });
  </script>
</body>
</html>